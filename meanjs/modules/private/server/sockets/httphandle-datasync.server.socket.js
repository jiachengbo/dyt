"use strict";function checkPacket(e){var t,r={};if(!e)return"数据包空错误";if(!e.wwyt_tableName||"string"!=typeof e.wwyt_tableName)return"参数同步表名称 wwyt_tableName 无效或类型错误";if(r.tableName=e.wwyt_tableName.trim(),delete e.wwyt_tableName,!e.wwyt_streetID||"string"!=typeof e.wwyt_streetID)return"参数同步街道 wwyt_streetID 无效或类型错误";if(r.streetID=e.wwyt_streetID.trim(),delete e.wwyt_streetID,t=Number(e.wwyt_type),isNaN(t)||t!==TYPE.ADD&&t!==TYPE.UPDATE&&t!==TYPE.DEL)return"参数同步类型 wwyt_type 错误";r.type=t,delete e.wwyt_type,r.field={};for(var o in e)0!==e[o].length?r.field[o]=e[o]:r.field[o]=null;return r}function Cmd_DataSync(){Command.apply(this,arguments)}function Req_DataSync(){Request.apply(this,arguments)}var path=require("path"),RESULT=require(path.resolve("./modules/private/server/sockets/const.server.socket")).RESULT,Command=require(path.resolve("./modules/private/server/sockets/command.server.socket")),Request=require(path.resolve("./modules/private/server/sockets/request.server.socket")),sequelize=require(path.resolve("./config/lib/sequelize")),dbTools=require(path.resolve("./config/private/dbtools")),multer=require(path.resolve("./config/private/multer")),logger=require(path.resolve("./config/lib/logger")).getLogger("socketio.HttpDataSync"),SCHEMA="wwyt",TYPE={ADD:1,UPDATE:2,DEL:3};Cmd_DataSync.prototype=Object.create(Command.prototype),Cmd_DataSync.prototype.recvRespon=function(e,t){return logger.debug("Cmd_DataSync recvrespon:",e,t),Object.getPrototypeOf(Object.getPrototypeOf(this)).recvRespon(e,t)},Req_DataSync.prototype=Object.create(Request.prototype),Request.prototype.listen=function(e){},Request.prototype.stopListen=function(){},Request.prototype.updateReqPacket=function(e,t){return e},Request.prototype.sendRespon=function(e,t,r,o,n){o?(t.lastsend_time=new Date,e?o.status(422).send({message:e.message}):o.json(t.msgsend)):logger.error("REQUEST %s need respon, but res not valid",this.msgcode)};var uploadFile=new multer("wwyt",10485760);uploadFile.mkPaths(),Req_DataSync.prototype.recvRequest=function(e,t,r){logger.debug("Req_DataSync recvrequest:",JSON.stringify(e));var o,n;return uploadFile.recv(t,r).then(function(r){if(logger.debug("Req_DataSync recvrequest body:",t.body),e.msgrecv=t.body,e.lastrecv_time=new Date,"string"==typeof(n=checkPacket(t.body)))throw new Error("packet format error:"+n);if(!(o=dbTools.getModel(n.tableName)))throw new Error("model:"+n.tableName+" not defined");return SCHEMA&&(o=o.schema(SCHEMA)),Array.isArray(r)&&r.forEach(function(e){n.field[e.fieldname]=path.join(uploadFile.mountDir,e.filename).replace(/\\/g,"/"),logger.debug("recv field %s,file %s => %s",e.fieldname,e.filename,n.field[e.fieldname])}),o.describe().catch(function(e){return o.sync({loging:!1})})}).then(function(e){if(n.field.streetID=n.streetID,n.type===TYPE.ADD)return o.create(n.field);var t=o.build(n.field).where();return o.findOne({where:t}).then(function(e){if(!e)throw new Error("no find record field key:"+JSON.stringify(t));if(n.type===TYPE.UPDATE)return e.update(n.field);if(n.type===TYPE.DEL)return e.destroy();throw new Error("packet type error:"+n.type)})}).then(function(t){return e.msgsend="model:"+n.tableName+" type:"+n.type+" good",RESULT.GOOD})},exports.Command=Cmd_DataSync,exports.Request=Req_DataSync,exports.TYPE=TYPE,exports.checkPacket=checkPacket;