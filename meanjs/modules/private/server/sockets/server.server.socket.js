"use strict";function SocketsCtrl(){EventEmitter.call(this)}var path=require("path"),fs=require("fs"),EventEmitter=require("events"),sequelize=require(path.resolve("./config/lib/sequelize")),putils=require(path.resolve("./config/private/utils")),dbTools=require(path.resolve("./config/private/dbtools")),GroupSocket=require(path.resolve("./modules/private/server/sockets/groupsocket.server.socket")),UserTask=require(path.resolve("./modules/private/server/sockets/usertask.server.socket")),mhCfgList=require(path.resolve("./modules/private/server/sockets/server-msghandle-cfglist.server.socket")),hhCfgList=require(path.resolve("./modules/private/server/sockets/server-httphandle-cfglist.server.socket")),httpTaskCfgs=require(path.resolve("./modules/private/server/sockets/server-httptask-cfglist.server.socket")),constVALUES=require(path.resolve("./modules/global/server/config/const.server.config")),usersCtrl=require(path.resolve("./modules/private/server/controllers/users-control.server.controller")),logger=require(path.resolve("./config/lib/logger")).getLogger("socketio.server");const RECSTATES=constVALUES.RECSTATES,RECACT=constVALUES.RECACT,STATEIN_END="_IN",STATEOUT_END="_OUT";SocketsCtrl.prototype=Object.create(EventEmitter.prototype);var socketsCtrl=new SocketsCtrl;module.exports=socketsCtrl;var EVENTTYPE=socketsCtrl.EVENTTYPE={TORECCHANGED:"torecChanged",NEWSOCKET:"newSocket"},groupSocket=new GroupSocket,userTask=new UserTask(mhCfgList,"socketio.server.usertask"),httpRecvTask=new UserTask(hhCfgList.hhRecvCfgList,"socketio.server.httprecvtask"),httpRecvTaskUser="httprecvtask";httpRecvTask.runTask(httpRecvTaskUser,httpTaskCfgs),socketsCtrl.dataSync=function(e,t,s){logger.debug("recv wwyt datasync header:",e.header("content-type")),httpRecvTask.callRecvRequest(httpRecvTaskUser,hhCfgList.hhRecvCfgList.DATASYNC,e,t,s)},socketsCtrl.handleEnd=function(e,t,s){logger.debug("recv wwyt handend"),httpRecvTask.callRecvRequest(httpRecvTaskUser,hhCfgList.hhRecvCfgList.DISPATCH,e,t,s)};var httpSendTask=new UserTask(hhCfgList.hhSendCfgList,"socketio.server.httpsendtask"),httpTaskArrayCfgs=httpTaskCfgs.getArrayCfgs();httpTaskArrayCfgs.forEach(function(e){httpSendTask.runTask(e.userId,e)}),usersCtrl.on(usersCtrl.USERRELOGIN,function(e){var t=groupSocket.getUserSocket(e);t&&(t.emit("USERRELOGIN"),setTimeout(function(){t.disconnect(!0)}))}),socketsCtrl.sendStateChangedMsg=function(e,t,s,r){var o,a,c,i,n=[];o=putils.getValueName(t,RECSTATES),e?(a=o+"_IN",c=mhCfgList.STATEIN,i={desc:"in state: "+o}):(a=o+"_OUT",c=mhCfgList.STATEOUT,i={desc:"out state: "+o}),i.act=s,i.torec=r;var d=r.get("lastact_userid");d&&n.push(d);var l=groupSocket.getGroupUsers(a,n);return userTask.addSendRecs(l,c,i,{torecid:r.id,actid:s.id})},socketsCtrl.sendDispatchMsg=function(e,t,s){for(var r=0;r<e.length;r++){var o=e[r];if(!httpSendTask.isValidUser(o))return userTask.addSendRecs(e,mhCfgList.DISPATCH,{desc:s.lastact_content,act:t,torec:s},{torecid:s.id,actid:t.id});httpSendTask.addSendRecs(o,hhCfgList.hhSendCfgList.DISPATCH,dbTools.getModelValues(s),{torecid:s.id,actid:t.id})}},socketsCtrl.on(EVENTTYPE.TORECCHANGED,function(e){var t=e.get("act");if(!Array.isArray(t)||0===t.length)return void logger.error("recv torecChanged id act error",e.id);var s=t[t.length-1],r=s.old_state_id,o=e.get("state_id");logger.debug("recv torecChanged id %d, %s => %s",e.id,putils.getValueName(r,RECSTATES),putils.getValueName(o,RECSTATES)),r!==o&&(r&&this.sendStateChangedMsg(!1,r,s,e),o&&this.sendStateChangedMsg(!0,o,s,e));var a=e.get("lastact_recvuserid");a&&a.length>0&&this.sendDispatchMsg(a,s,e)}),socketsCtrl.on(EVENTTYPE.NEWSOCKET,function(e,t){logger.debug("newSocket socket connect, id %s,username %s",e.id,t.username);for(var s in RECSTATES)if(RECSTATES.hasOwnProperty(s)){var r=s+"_IN",o=s+"_OUT";-1!==t.roles.indexOf(r)&&groupSocket.add(r,e),-1!==t.roles.indexOf(o)&&groupSocket.add(o,e)}groupSocket.add("sockets",e),e.on("disconnect",function(){logger.debug("socket user %s leave.",t.username),groupSocket.removeAll(e),userTask.clearUser(t)}),userTask.runTask(t,e)});