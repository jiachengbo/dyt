"use strict";function Request(e,t,r){EventEmitter.call(this),this.socket=e,this.msgcode=t,this.options="object"==typeof r&&r||{}}var path=require("path"),EventEmitter=require("events"),putils=require(path.resolve("./config/private/utils")),RESULT=require(path.resolve("./modules/private/server/sockets/const.server.socket")).RESULT,logger=require(path.resolve("./config/lib/logger")).getLogger("socketio.request");Request.prototype=Object.create(EventEmitter.prototype),module.exports=Request,Request.prototype.REQEND="REQEND",Request.prototype.REQERROR="REQERROR",Request.prototype.buildDefReq=function(){return{id:-1,first_time:new Date,attempttimes:1,msgrecv:null,lastrecv_time:new Date,msgsend:null,lastsend_time:null}},Request.prototype.updateReqPacket=function(e,t){return t&&"object"==typeof t?"number"!=typeof t.id?"request col id not valid error":(e.reqid=t.id,"string"!=typeof t.lastsend_time?"request col lastsend_time not valid error":(e.first_time=new Date(t.lastsend_time),"number"!=typeof t.attempttimes?"request col attempttimes not valid error":(e.attempttimes=t.attempttimes,e.msgrecv=t.msgsend,e.lastrecv_time=new Date,e))):"request data not valid error"},Request.prototype.listen=function(e){this.socket.on(this.msgcode,e.bind(this))},Request.prototype.stopListen=function(){this.socket.removeListener(this.msgcode)},Request.prototype.sendRespon=function(e,t,r,s){this.options.respon&&(s?(t.lastsend_time=new Date,s(e,t.msgsend)):logger.error("REQUEST %s need respon, but fn not valid",this.msgcode))},Request.prototype.recvRequest=function(e){return Promise.resolve(RESULT.GOOD)},Request.prototype.recvRequestCallBack=function(){var e=this.buildDefReq(),t=Array.from(arguments);t.unshift(e);var r=this.updateReqPacket.apply(this,t);if("string"==typeof r)return this.sendRespon.apply(this,[new Error(r)].concat(t)),e.result=RESULT.ERROR,e.msgsend={data:e.msgsend,error:r},void this.emit(this.REQERROR,e);var s=this,o=setTimeout(function(){o=null,r="request timeout",s.sendRespon.apply(s,[new Error(r)].concat(t)),e.result=RESULT.TIMEOUT,e.msgsend={data:e.msgsend,error:"request timeout"},s.emit(s.REQERROR,e)},this.options.timeout<=0?1e3:s.options.timeout);this.recvRequest.apply(this,t).then(function(r){if(!o)return void logger.warn("request %s recvRequest return, but already timeout %d",s.msgcode,s.options.timeout);if(clearTimeout(o),"number"!=typeof r)throw new Error("return not number");if(r!==RESULT.GOOD)throw new Error("recvRequest return result error:"+r);s.sendRespon.apply(s,[null].concat(t)),e.result=r,s.emit(s.REQEND,e)}).catch(function(r){if(logger.error("request %s recvRequest error:",s.msgcode,r),!o)return void logger.warn("request %s recvRequest return, but already timeout %d",s.msgcode,s.options.timeout);clearTimeout(o),s.sendRespon.apply(s,[r].concat(t)),e.result>=RESULT.NOCOMPLETE&&(e.result=RESULT.ERROR),e.msgsend=r,s.emit(s.REQERROR,e)})};