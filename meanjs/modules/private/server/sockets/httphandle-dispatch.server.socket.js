"use strict";function Cmd_Dispatch(){Command.apply(this,arguments)}function Req_Dispatch(){Request.apply(this,arguments)}function checkPacket(e,t){var r={};if(!e||"object"!=typeof e)return"请求包空或不是对象错误";if(!e.wwyt_streetID||"string"!=typeof e.wwyt_streetID)return"请求包字段 wwyt_streetID 无效或类型错误";if(!e.streetIssueId||"string"!=typeof e.streetIssueId)return"请求包字段 streetIssueId 无效或类型错误";r.other={streetIssueId:e.streetIssueId.trim()};var s=t.getStreetCfg(e.wwyt_streetID.trim());return s?(r.other.userId=s.userId,e.result&&"string"==typeof e.result?(r.act={act_id:RECACT.HANDLERET,act_content:e.result,act_remark:e.method},r):"请求包字段 result 无效或类型错误"):"请求包字段 wwyt_streetID 在http任务配置中没有找到"}var path=require("path"),fs=require("fs"),RESULT=require(path.resolve("./modules/private/server/sockets/const.server.socket")).RESULT,Command=require(path.resolve("./modules/private/server/sockets/command.server.socket")),Request=require(path.resolve("./modules/private/server/sockets/request.server.socket")),constVALUES=require(path.resolve("./modules/global/server/config/const.server.config")),multer=require(path.resolve("./config/private/multer")),sequelize=require(path.resolve("./config/lib/sequelize")),logger=require(path.resolve("./config/lib/logger")).getLogger_FileNameBase(__filename);const RECSTATES=constVALUES.RECSTATES,RECACT=constVALUES.RECACT;Cmd_Dispatch.prototype=Object.create(Command.prototype),Cmd_Dispatch.prototype.recvRespon=function(e,t){return e?(e instanceof Error||(e=new Error(e.message||"unknow error message")),Promise.reject(e)):Promise.resolve(RESULT.GOOD)},Command.prototype.buildMsg=function(e){var t={};if(!e||"object"!=typeof e)return"cmdRec空或不是对象错误";var r=e.msgsend;t.streetIssueId="",t.communityId="",t.gridId="",t.roadId="",t.issueType="",t.issueTypeDetail="",t.status="",t.method="",t.result="",t.Beforepic2="",t.Beforepic3="",t.afterpic="",t.Afterpic2="",t.issueObjectType="组织",t.issueObject="区执法局下派",t.issueAddress=r.address,t.issueContext=r.eventdesc+"::"+r.lastact_content,t.createUser="区执法局",t.createDepartment="区执法局",t.createDate=(new Date).toLocaleString(),t.lat=r.coordinatex+"",t.lng=r.coordinatey+"";var s="";if(r.create_photo)try{s=fs.readFileSync(path.resolve("."+r.create_photo),"base64")}catch(e){}return t.beforepic=s,t},Cmd_Dispatch.prototype.sendCmd=function(e,t,r){var s=this.buildMsg(e);if("string"==typeof s)return r(new Error(s),null);var o=this.socket.url+"/saveStreetIssue_SZCG";require("request").post({url:o,form:s},function(t,s,n){if(!t&&200===s.statusCode){var i=/>(\S+)<\/string>$/m,a=i.exec(n);if(a&&Array.isArray(a)&&a[1]){var c=a[1].split(",");if(c.length>1&&"1"===c[0])return logger.debug("cmd %s successful!  Server responded with:",e.msgcode,c[1]),r(null,c[1])}}t||(t=new Error("cmd "+e.msgcode+"send to "+o+" response code "+s.statusCode+" failed:"+n)),r(t,n)})},Req_Dispatch.prototype=Object.create(Request.prototype),Request.prototype.listen=function(e){},Request.prototype.stopListen=function(){},Request.prototype.updateReqPacket=function(e,t){return e},Request.prototype.sendRespon=function(e,t,r,s,o){s?(t.lastsend_time=new Date,e?s.status(422).send({message:e.message}):s.json(t.msgsend)):logger.error("request %s need respon, but res not valid",this.msgcode)};var uploadImage=new multer("torec",10485760,/image/,".jpg"),CommTaskM=sequelize.model("CommTask");Req_Dispatch.prototype.recvRequest=function(e,t,r){var s,o=this,n=sequelize.model("Torec");return uploadImage.recv(t,r).then(function(r){if(logger.debug("Req_Dispatch recvrequest:",t.body),e.msgrecv=t.body,e.lastrecv_time=new Date,"string"==typeof(s=checkPacket(t.body,o.socket)))throw new Error("packet format error:"+s);return Array.isArray(r)&&r.forEach(function(e){"afterpic"===e.fieldname.toLowerCase()?(s.act.act_photo=path.join(uploadImage.mountDir,e.filename).replace(/\\/g,"/"),logger.debug("recv field %s,file %s => %s",e.fieldname,e.filename,s.act.act_photo)):logger.warn("ignore recv field %s,file %s => %s",e.fieldname,e.filename)}),CommTaskM.findAll({where:{user:s.other.userId,result:RESULT.GOOD,reqid:null,msgrecv:JSON.stringify(s.other.streetIssueId)},order:"id ASC"}).then(function(e){if(e.length<=0)throw new Error("packet key not find:"+s);var t=e[e.length-1].torecid;return n.findById(t)}).then(function(e){if(e)return e.getAct({order:"act_time ASC"}).then(function(r){return e.set("act",r,{raw:!0}),t.model=e,t.user={id:s.other.userId,roles:[]},t.body=s,require(path.resolve("./modules/private/server/controllers/torec.server.controller")).update(t,null).then(function(e){if(e instanceof Error)throw e})});throw logger.error("torec findbyid find null error"),new Error("Failed to load torec id ")})}).then(function(t){return e.msgsend="dispatch request good",RESULT.GOOD})},exports.Command=Cmd_Dispatch,exports.Request=Req_Dispatch;